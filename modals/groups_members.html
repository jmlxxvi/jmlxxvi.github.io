<div class="modal-header">
        <h5 class="modal-title"><span class="i18n" data-i18n="MEMBERS_OF">MEMBERS_OF</span> "<span id="groups_members_title_id"></span>"</h5>
    </div>
    <div class="modal-body">
        <form id="groups_members_member_form">
            <div class="form-group">
                <label for="groups_members_username"><span class="i18n" data-i18n="USER_NAME">USER_NAME</span></label><span class="text-danger">&nbsp;*</span>
                <!-- <input type="text" class="form-control" id="groups_members_member_name" name="groups_members_member_name" style="text-transform: uppercase;"> -->
                <select id="groups_members_member_name" name="groups_members_member_name"></select>
            </div>
    
            <div id="groups_members_members_table"></div>
    
        </form>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-secondary" data-dismiss="modal"><span class="i18n" data-i18n="CLOSE">CLOSE</span></button>
    </div>
    
    <script>
    
        (() => {
    
            INDEX.i18n.apply();
    
            const group_id = INDEX.data.get("groups_members_id");
            const group_name = INDEX.data.get("groups_members_name");
    
            $("#groups_members_title_id").html(group_name);

            var s2 = [];

            $("#groups_members_member_name").select2({ //const groups_members_member_name_elem = 
                width: 'style',
                dropdownParent: $("#groups_members_member_name").parent(),
                theme: "bootstrap4",
                data: s2
            });

            const groups_members_generate_table = (data) => {

                let table_html = "<table class='table'>";

                for (const row of data) {

                    table_html += "<tr><td>" + row[1] + "</td><td style='text-align: right;'><a href='#' class='groups_members_delete_memeber_from_group' data-uid='" + row[0] + "'><i class='fas fa-times'></i></a></td></tr>";

                }
                
                table_html += "</table>";

                $("#groups_members_members_table").html(table_html);

            };

            const groups_members_show_user_select = (group_id) => {

                ZOMBI.server(
                    ["sys_groups", "groups_users_shift_to_group", group_id],
        
                    (error, response) => {
        
                        if(error) { INDEX.flash(INDEX.i18n.label("SERVER_ERROR")); } 
                        
                        else {
        
                            if(response.error) { INDEX.flash(response.message); } 
                            
                            else {
        
                                const out_group = response.data[0];
                                const in_group = response.data[1];

                                out_group.unshift([-1, INDEX.i18n.label("SELECT_A_USER")]);

                                s2 = out_group.map(function(x) {
                                    return {id: x[0], text: x[1]};
                                });

                                $("#groups_members_member_name").empty();

                                // TODO check if there is a way to update the component without recreating it as it flashes when selecting
                                $("#groups_members_member_name").select2({
                                    width: 'style',
                                    dropdownParent: $("#groups_members_member_name").parent(),
                                    theme: "bootstrap4",
                                    data: s2
                                });

                                groups_members_generate_table(in_group);
        
                            }
                        
                        }
                    
                    }
        
                );

            };


            groups_members_show_user_select(group_id);

            $('#groups_members_member_name').on("select2:selecting", function(e) { 

                console.log(e.params.args.data);
                
                const user_id = e.params.args.data.id;
                
                const user_name = e.params.args.data.text;

                ZOMBI.server(
                    ["sys_groups", "groups_add_user_to_group", [group_id, user_id]],
        
                    (error, response) => {
        
                        if(error) { INDEX.flash(INDEX.i18n.label("SERVER_ERROR")); } 
                        
                        else {
        
                            if(response.error) { INDEX.flash(response.message); } 
                            
                            else {
        
                                groups_members_show_user_select(group_id);
        
                            }
                        
                        }
                    
                    }
        
                );

            });

            // .off is to prevent multiple bindings every time the modal is opened, see: http://api.jquery.com/off/
            $("body").off("click", ".groups_members_delete_memeber_from_group").on("click", ".groups_members_delete_memeber_from_group", function(event) {

                event.preventDefault();

                const user_id = $(this).data("uid");

                console.log(user_id);

                ZOMBI.server(
                    ["sys_groups", "groups_remove_user_from_group", [group_id, user_id]],
        
                    (error, response) => {
        
                        if(error) { INDEX.flash(INDEX.i18n.label("SERVER_ERROR")); } 
                        
                        else {
        
                            if(response.error) { INDEX.flash(response.message); } 
                            
                            else {
        
                                groups_members_show_user_select(group_id);
        
                            }
                        
                        }
                    
                    }
        
                );

            });
    
        })();
    
    </script>
    
    